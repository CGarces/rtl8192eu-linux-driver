language: c
compiler: gcc
dist: bionic
os: linux

before_install:
  - export KERNEL_URL_DETAILS=$(wget --quiet -O - ${KERNEL_URL}v${KVER_BUILD}/ | grep -A8 "Build for ${TRAVIS_CPU_ARCH}")
  - export ALL_DEB=$(echo "$KERNEL_URL_DETAILS" |  grep -m1 'all.deb' | cut -d '"' -f 2)
  - export KVER=$(echo $ALL_DEB | cut -d '_' -f 1 | cut -c15-)-generic
  - wget ${KERNEL_URL}v${KVER_BUILD}/$(echo "$KERNEL_URL_DETAILS" | grep -m1 "${TRAVIS_CPU_ARCH}.deb" | cut -d '"' -f 2)
  - wget ${KERNEL_URL}v${KVER_BUILD}/$ALL_DEB
  #- sudo dpkg -i *.deb

script: true #make CC=$CC KVER=$KVER

env:
  global:
    - KERNEL_URL=https://kernel.ubuntu.com/~kernel-ppa/mainline/
    - KERNEL_MAINLINE="$(curl -s https://www.kernel.org/ | grep -A1 'mainline:' | grep -oP '(?<=strong>).*(?=</strong.*)')"

  matrix:
    - KVER_BUILD=$KERNEL_MAINLINE
    #On Cron build only mainline kernel is tested.
    - if: env(TRAVIS_EVENT_TYPE) != cron
    - KVER_BUILD=5.6.5
    - if: env(TRAVIS_EVENT_TYPE) != cron
    - KVER_BUILD=5.5.18
 #Kernels 5.4 with minor versions > 27 are failing on amd64. Not upgrade the minor version without check https://kernel.ubuntu.com/~kernel-ppa/mainline/ 
    - if: env(TRAVIS_EVENT_TYPE) != cron
    - KVER_BUILD=5.4.27
    - if: env(TRAVIS_EVENT_TYPE) != cron
    - KVER_BUILD=4.19.116
    - if: env(TRAVIS_EVENT_TYPE) != cron
    - KVER_BUILD=4.9.219
    - if: env(TRAVIS_EVENT_TYPE) != cron
    - KVER_BUILD=4.4.219
    - if: env(TRAVIS_EVENT_TYPE) != cron
    - KVER_BUILD=3.16.82

cache:
  - ccache: true

jobs:
  exclude:
    #Kernels >= 5.4 No longer builds on gcc-7.4 So excluded from build matrix and will handle on "include array". should be fixed by gcc-7.5 
    #Mainline kernel is compiled on GCC 9 also.
    - KVER_BUILD=$KERNEL_MAINLINE
    - KVER_BUILD=5.6.5
    - KVER_BUILD=5.5.18
    #LTS Kernels < 5.4 use GCC instaled on Travis instance, so no apt is required, the are populated by the build matrix.
  include:
    - addons:
        apt:
          sources:
            - sourceline: "ppa:ubuntu-toolchain-r/test"
          packages:
            - gcc-9
      env: CC=gcc-9 KVER_BUILD=$KERNEL_MAINLINE
    - addons:
        apt:
          packages:
            - gcc-8
      env: CC=gcc-8 KVER_BUILD=$KERNEL_MAINLINE

    - addons:
        apt:
          packages:
            - gcc-8
      env: CC=gcc-8 KVER_BUILD=5.6.5
    - addons:
        apt:
          packages:
            - gcc-8
      env: CC=gcc-8 KVER_BUILD=5.5.18
    - addons:
        apt:
          packages:
            - gcc-8
      env: CC=gcc-8 KVER_BUILD=5.4.27
