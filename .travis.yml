language: c
compiler: gcc
dist: bionic
os: linux

env:
  global:
    - KERNEL_URL=https://kernel.ubuntu.com/~kernel-ppa/mainline/
    - KERNEL_MAINLINE=$(curl -s https://www.kernel.org/releases.json | grep 'mainline' -B1 | head -1 | cut -d'"' -f4)
    - KERNEL_STABLE=$(curl -s https://www.kernel.org/releases.json | grep -A1 'latest_stable' | tail -1 | cut -d'"' -f4)
  jobs:
    - KVER_BUILD=$KERNEL_MAINLINE
    - KVER_BUILD=$KERNEL_STABLE
    - KVER_BUILD=5.5.19 #EOL
 #Kernels 5.4 with minor versions > 28 are failing on amd64. Not upgrade the minor version without check https://kernel.ubuntu.com/~kernel-ppa/mainline/ 
    - KVER_BUILD=5.4.28
    - KVER_BUILD=4.19.116
    - KVER_BUILD=4.9.219
    - KVER_BUILD=4.4.219
    - KVER_BUILD=3.16.82
cache:
  - ccache: true

stages:
  - warm_cache # this ensures a "user" install works properly
  - test # all tests
  
stage: 
  - name: test
    workspaces:
    use:
      - apt_cache

jobs:
  include:
    - stage: warm_cache
      script: true
      addons:
        apt:
          #Force update to GCC-7.5 in order to compile Kernels >= 5.4.
          packages: gcc-7
      workspaces:
        create:
          name: apt_cache
    #Mainline kernel is also compiled on GCC 8 & 9. Jobs are added to the build matrix expansion
    - stage: test
      addons:
        apt:
          sources:
            - sourceline: "ppa:ubuntu-toolchain-r/test"
          packages:
            - gcc-9
      env: CC=gcc-9 KVER_BUILD=$KERNEL_MAINLINE
    - stage: test
      addons:
        apt:
          packages:
            - gcc-8
      env: CC=gcc-8 KVER_BUILD=$KERNEL_MAINLINE

